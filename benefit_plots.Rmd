---
title: "Benefit Plots"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(broom)
library(knitr)
library(jtools)

# commonality analysis for GLM
source("ca_glm.R")
```

In this document, we analyse the results of the simulations generated using `es_benefit.R`. 

```{r load_data}
load("results/benefit_all_replicates.rda")
```

```{r manipulate_data}
res <- out %>% 
  filter(ee_thresh == 20, es_thresh == 20) %>% 
  mutate(amt_scenario = case_when(p_supply == 0.1 & p_demand == 0.1 ~ "LowS_LowD",
                                  p_supply == 0.4 & p_demand == 0.1 ~ "HighS_LowD",
                                  p_supply == 0.1 & p_demand == 0.4 ~ "LowS_HighD",
                                  p_supply == 0.4 & p_demand == 0.4 ~ "HighS_HighD",
                                  TRUE ~ "None"),
         service_scenario = case_when(beta == 0 & gamma == 0.1 & rival == TRUE ~ "type1",
                                      beta == 0 & gamma == 0.1 & rival == FALSE ~ "type2",
                                      beta == 0 & gamma == 0.0001 & rival == TRUE ~ "type3",
                                      beta == 0 & gamma == 0.0001 & rival == FALSE ~ "type4",
                                      beta == 0.5 & gamma == 0.1 & rival == TRUE ~ "type5",
                                      beta == 0.5 & gamma == 0.1 & rival == FALSE ~ "type6",
                                      beta == 0.5 & gamma == 0.0001 & rival == TRUE ~ "type7",
                                      beta == 0.5 & gamma == 0.0001 & rival == FALSE ~ "type8")) %>% 
  select(amt_scenario, service_scenario, f_supply, f_demand, inter, benefit)
```

## Typologies

```{r}
knitr::include_graphics('figs/typology.png')
```

In the below plots, the service types are numbered left-to-right, top-to-bottom (e.g. type one is plantation forestry, type 5 is wind pollinated crops/hunting etc.). 

## Sensitivity to landscape configuration parameters

For each subgroup (unique combinations of ES type based on service scenario), we fit a Poisson GLM with the landscape parameters as covariates (f_supply, f_demand, inter, amt_scenario). We also include the interaction between each configuration parameter (f_supply, f_demand, inter) and the amount scenario to get an idea of whether the relationship between landscape configuration and ES benefit changes with landscape composition. 

The plots below are partial effect plots for the landscape configuration variables at each level of amount scenario. 

```{r define_functions}
# change here to change model structure
mod_fit <- function(dat) {
  glm(benefit ~ f_supply * amt_scenario + f_demand * amt_scenario + inter * amt_scenario, data = dat, family = "poisson")
}

# change here to change variables that are scaled
scale_cols <- function(x) {
  scale_this <- function(y) as.vector(scale(y))
  mutate_at(x, .vars = vars(f_supply, f_demand, inter), .funs = funs(scale_this))
}

# change here if model structure changes
get_preds <- function(mod, pred) {
  make_predictions(mod, pred = pred, modx = "amt_scenario")$predicted %>% 
    mutate(covariate = pred) %>% 
    select(benefit, pred = !!pred, modx_group, covariate)
}

get_all_preds <- function(mod) {
  get_preds(mod, "f_supply") %>% 
    bind_rows(get_preds(mod, "f_demand")) %>% 
    bind_rows(get_preds(mod, "inter"))
}
```

```{r, warning = FALSE, message = FALSE, fig.width=10, fig.height = 15}
mod <- res %>% 
  group_by(service_scenario) %>% 
  nest() %>% 
  mutate(data_scaled = map(data, scale_cols),
         mod = map(data_scaled, mod_fit),
         mod_tidy = map(mod, tidy),
         mod_glance = map(mod, glance),
         mod_preds = map(mod, get_all_preds))

preds <- mod %>% select(service_scenario, mod_preds) %>% 
  unnest()



ggplot(preds, aes(x = pred, y = benefit, colour = covariate)) + 
  geom_line() + 
  scale_color_discrete(name = "Covariate") + 
  facet_grid(service_scenario ~ modx_group, scales = "free")
```

NB The relationship between ES benefit and both fragmentation parameters is pretty similar, this is why f_demand lines are not visible. This is something worth discussing (e.g. is this to do with the way we have written the benefit function, or is it an actual result). 

Below are a couple of other ways to cut the visualisation

```{r, fig.width=10, fig.height = 15}
ggplot(preds, aes(x = pred, y = benefit)) + 
  geom_line() + 
  facet_grid(service_scenario ~ modx_group + covariate, scales = "free")
```

```{r, fig.width=10, fig.height = 15}
ggplot(preds, aes(x = pred, y = benefit, colour = modx_group)) + 
  geom_line() + 
  scale_color_discrete(name = "Amount Scenario") + 
  facet_grid(service_scenario ~ covariate, scales = "free")
```