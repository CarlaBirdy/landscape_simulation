---
title: "Benefit Plots"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(broom)
library(knitr)

# commonality analysis for GLM
source("ca_glm.R")
```

In this document, we analyse the results of the simulations generated using `es_benefit.R`. 

```{r load_data}
dat <- readRDS("results/benefit_all_replicates.rds")
```

```{r manipulate_data}
res <- dat %>% 
  mutate(rival = case_when(rival == FALSE ~ "Non-rival",
                           TRUE ~ "Rival"),
         amt_scenario = case_when(p_supply == 0.1 & p_demand == 0.1 ~ "LowS_LowD",
                                  p_supply == 0.4 & p_demand == 0.1 ~ "HighS_LowD",
                                  p_supply == 0.1 & p_demand == 0.4 ~ "LowS_HighD",
                                  p_supply == 0.4 & p_demand == 0.4 ~ "HighS_HighD",
                                  TRUE ~ "None"),
         link_scenario = case_when(is.na(ee_thresh) & es_thresh == 20 ~ "NoSS_ProxSD",
                                   is.na(ee_thresh) & es_thresh == 100 ~ "NoSS_FullSD",
                                   ee_thresh == 20 & es_thresh == 20 ~ "ProxSS_ProxSD",
                                   ee_thresh == 20 & es_thresh == 100 ~ "ProxSS_FullSD",
                                   ee_thresh == 100 & es_thresh == 100 ~ "FullSS_FullSD",
                                   ee_thresh == 100 & es_thresh == 20 ~ "FullSS_ProxSD",
                                   TRUE ~ "None")) %>% 
  select(amt_scenario, link_scenario, rival, alpha, beta, gamma, f_supply, f_demand, inter, benefit)
```

## Sensitivity to landscape configuration parameters

In this section, for each subgroup (unique combinations of ES type based on link scenario, amount scenario, rival/non-rival and benefit function parameters), we fit a Poisson GLM with the landscape configuration parameters as covariates (f_supply, f_demand, inter). This document presents the results for all combinations that we have simulated: 

- $\alpha = 0.5, 1.0, 1.5$
- $\beta = -0.1, 0, 0.1$
- $\gamma = 0.000001, 0.001, 0.1$

```{r define_functions}
# change here to change model structure
mod_fit <- function(dat) {
  glm(benefit ~ f_supply + f_demand + inter, data = dat, family = "poisson")
}

# change here to change variables that are scaled
scale_cols <- function(x) {
  scale_this <- function(y) as.vector(scale(y))
  mutate_at(x, .vars = vars(f_supply, f_demand, inter), .funs = funs(scale_this))
}
```

```{r, warning = FALSE, message = FALSE}
params <- res %>% distinct(alpha, beta, gamma)

plots <- list()

for(i in 1:nrow(params)) {
  alpha_val <- params[i, "alpha"]
  beta_val <- params[i, "beta"]
  gamma_val <- params[i, "gamma"]
  mod <- res %>% 
    filter(alpha == alpha_val, beta == beta_val, gamma == gamma_val) %>% 
    group_by(amt_scenario, link_scenario, rival) %>% 
    nest() %>% 
    mutate(data_scaled = map(data, scale_cols),
           mod = map(data_scaled, mod_fit),
           mod_tidy = map(mod, tidy),
           mod_glance = map(mod, glance))
  
  coeffs <- mod %>% 
  select(amt_scenario, link_scenario, rival, mod_tidy) %>% 
  unnest() %>% 
  mutate_if(is.numeric, round, 3) 
  
  p_title <- bquote(list(alpha==.(alpha_val), beta==.(beta_val), gamma==.(gamma_val)))
  
  plots[[i]] <- ggplot(coeffs %>% filter(term %in% c("f_supply", "f_demand", "inter")), 
                       aes(x = term, y = estimate, fill = rival)) + 
    geom_bar(stat = "identity", position = "dodge") + 
    scale_fill_viridis_d() + 
    facet_grid(amt_scenario ~ link_scenario) + 
    labs(x = "", y = "Standardised coefficient estimate", title = p_title)
}
```

```{r, fig.width = 12, fig.height = 6}
print(plots)
```